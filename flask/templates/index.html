<!doctype html>
<html ng-app="car" ng-controller="carController">
<head>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
</head>
<body>
  <h1>Orange Crash</h1>
  <div>{{poll_ok ? "online" : "offline"}}</div>
  <div style='display:inline-block;margin:30px'>
    <div>{{car_state.v_bat | number:1}}V</div>
      <svg width="64" height="32">
      <rect x="2" y="2" width="60" height="28" style="fill:lightgray;stroke:gray;stroke-width:2" />
      <rect x="4" y="4" width="{{56*battery_percent/100}}" height="24" style="fill:black;stroke:black" />

    </svg>
    <div>{{battery_percent | number:0}}% </div>
  </div>
  <div style='display:inline-block';margin:30px>
    <div>Heading</div>
    <div>
    <svg width="32" height="32">
      <circle cx="16" cy="16" r="14" stroke="gray" stroke-width="2" fill="LightGray" />
      <line x1="16" y1="16" x2={{16-14*Math.sin(car_state.heading)}} y2={{16-14*Math.cos(car_state.heading)}} style="stroke:gray;stroke-width:2" />
    </svg>
    </div>

    <div>
      {{car_state.heading * 180 / Math.PI | number:0}}Â°
    </div>
  </div>
  <div style='display:inline-block;margin:30px'>
    <div ng-repeat="cpu in pi_state.cpu">cpu{{$index}} {{cpu}}
    </div>
  </div>

  <form>
    select a track:
    <select name='2' ng-model="selected_track" id="2" ng-options="track.name for track in tracks"></select>
    select a route: <select name='1' ng-model="selected_route" id="1" ng-options="route.name for route in routes"></select>
  </form>
  <button ng-click="go()">Go{{go_error}}</button>
  <button ng-click="stop()">Stop{{go_error}}</button>
  <h2> Selected track: {{selected_track.name}}!</h2>
  <h2> Selected route: {{selected_route.name}}!</h2>
  <label><h3><input type="checkbox" id="xxx" ng-model="display_car_state"> car_state: </h3></label>
  <div ng-if="display_car_state" ng-repeat="(key,value) in car_state">{{key}} = {{value}}</div>
  <table>
  <tr><td>secs</td><td>x</td><td>y</td></tr>
  <tr ng-repeat="path_node in route_path">
      <td>{{path_node.secs}}</td>
      <td>{{path_node.secs}}</td>
      <td>{{path_node.secs}}</td>
  </tr>
  </table>
</body>
<script>
var app = angular.module("car", []);
app.controller("carController", function($scope, $http, $timeout) {
  $scope.Math = Math
  $scope.run = function() {
    alert('run clicked')
  }
  $scope.selected_track = null;
  $scope.selected_route = null;

  $scope.go = function() {
    go_error = ""
    $http.put('/command/go',"1").success(function() {
      console.log('go success');
    }).error(function(response,code) {
      $scope.go_error = "  ("+code+")"+response.message;
    })
    console.log("go clicked");
  };

  $scope.stop = function() {
    $http.put('/command/stop',"1").success(function() {
      console.log('stop success');
    }).error(function(response,code) {
      $scope.stop_error = "  ("+code+")"+response.message;
    })
    console.log("stop clicked");
  };

  $scope.$watch("selected_track", function(newValue, oldValue) {
    if ($scope.selected_track !== null && $scope.selected_track.name.length > 0) {
      console.log("selected track:",$scope.selected_track)
      $http.get('/tracks/'+$scope.selected_track.name+"/routes").
        success(function(result, status, headers, config) {
          $scope.routes = result.routes;
        }).error(function(data, status, headers, config) {
          $scope.route_names = ['n/a'];
        // log error
      });
    }
  });

  $scope.$watch("selected_route", function(newValue, oldValue) {
    if ($scope.selected_route !== null && $scope.selected_route.name.length > 0) {
      $http.get('/tracks/'+$scope.selected_track.name+"/routes/"+$scope.selected_route.name+"/path").
        success(function(route_path, status, headers, config) {
          $scope.route_path = route_path;
        }).error(function(data, status, headers, config) {
          $scope.route_names = ['n/a'];
        // log error
        });
    }
  });


  $http.get('/tracks').
    success(function(result, status, headers, config) {
      $scope.tracks = result.tracks;
      $scope.route_names = ['data'];
    }).
    error(function(data, status, headers, config) {
      // log error
    });
  $scope.poll_ok = false;
  $scope.display_car_state = false;


  var poller = function() {
    $http({method:'GET', timeout:5000, url : '/car/get_state'})
      .then(function(r) {
        $scope.car_state = r.data;
        var v_bat = $scope.car_state.v_bat;
        var min_bat = 3.5 * 3;
        var max_bat = 4.2 * 3;
        $scope.battery_percent = 100*(v_bat-min_bat)/(max_bat-min_bat);
        $scope.poll_ok = true;
        $timeout(poller, 100);
      },
      function(e) { 
        $scope.poll_ok = false;
        $timeout(poller,1000);
      });
    };
  poller();

  var poller2 = function() {
    $http({method:'GET', timeout:5000, url : '/pi/get_state'})
      .then(function(r) {
        $scope.pi_state = r.data;
        $timeout(poller2,1000);
      },
      function(e) { 
        $timeout(poller2,1000);
      });
    };
  poller2();


});    
</script>    

</html>
