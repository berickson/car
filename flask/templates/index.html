<!doctype html>
<html ng-app="car" ng-controller="carController">
<head>
  <title>Orange Crash</title>
<style>
/* colors from https://coolors.co/738873-9b9992-dbd7cd-ffb97d-c3c7ba */

.changed {
  background-color:yellow;
}
.button {
  background-color: #738873;
  border: none;
  border-radius: 5px;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;

  /*https://www.cssmatic.com/box-shadow*/
  -webkit-box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
  -moz-box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
  box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
}

.select {
   
   background-color:rgb(220,220,220);
   /*height: 34px;*/
   font-size: 24px;
   /* width: 240px; */
}


.small_text {
  font-size: 10px;
}

.bigtext {
  font-size: 28px;
}


.groupbox {
  background-color:#DBD7CD;
  margin:10px;
  padding:10px;
  display:block;
  font-family: Consolas, monaco, monospace;
  /*https://www.cssmatic.com/box-shadow*/
  -webkit-box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
  -moz-box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
  box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
}

.row {
  display:flex;
  flex-direction: row;
  align-items:stretch;
}

.itembox {
  background-color:#C3C7BA;
  margin:5px;
  padding:5px;
  
  
  font-family: Consolas, monaco, monospace;
  display:inline-block;

  /*https://www.cssmatic.com/box-shadow*/
  -webkit-box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
  -moz-box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
  box-shadow: 5px 5px 11px -2px rgba(0,0,0,0.5);
}

.data {
  white-space: pre;
}

.orange {
  color:#FFB97D;
  display:inline;
  margin:10px;
  padding:0px;
}

.main {
  background-color:#9B9992;
  font-family: Consolas, monaco, monospace;
}

</style>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
</head>
<body class='main'>
  <h1 class='orange'>Orange Crash</h1>
  <div class='itembox'>{{poll_ok ? "online - " + car_state.mode : "offline"}}</div>
  <div class="groupbox row">
    <div class='itembox'>
        <div class='bigtext data'>{{ rjust((car_state.velocity * 2.23694).toFixed(1),5) }}</div>
        <div style='text-align:right'>mph</div>
        <div style='text-align:right' class='data'>{{ rjust(car_state.velocity.toFixed(1),5) }} m/s</div>
      </div>
    <div class="itembox">
    <div >{{car_state.v_bat | number:1}}V</div>
      <svg width="64" height="32">
      <rect x="2" y="2" width="60" height="28" style="fill:lightgray;stroke:gray;stroke-width:2" />
      <rect x="4" y="4" width="{{56*battery_percent/100}}" height="24" style="fill:black;stroke:black" />

    </svg>
    <div>{{battery_percent | number:0}}% </div>
  </div>
    <div class='itembox'>
      <div>Heading</div>
        <div>
          <svg width="32" height="32">
            <circle cx="16" cy="16" r="14" stroke="gray" stroke-width="2" fill="LightGray" />
            <line x1="16" y1="16" x2={{16-14*Math.sin(car_state.heading)}} y2={{16-14*Math.cos(car_state.heading)}} style="stroke:gray;stroke-width:2" />
          </svg>
          </div>
        <div>
        {{car_state.heading * 180 / Math.PI | number:0}}Â°
      </div>
    </div>
    <div class='itembox'>
      <div>Position</div>
      <div>x: {{car_state.front_x.toFixed(2)}}</div>
      <div>y: {{car_state.front_y.toFixed(2)}}</div>
    </div>
    <div class='itembox'>
      <table class='data small_text'>
        <thead><td></td><td>      v</td><td>v_smooth</td><td>a_smooth</td></thead>
        <tbody>
          <tr ng-repeat = 'wheel in ["fl","fr","bl","br"]'>
            <td>{{wheel}}</td>
            <td>{{rjust(car_state[wheel].v.toFixed(2),7)}}</td>
            <td>{{rjust(car_state[wheel].v_smooth.toFixed(2),8)}}</td>
            <td>{{rjust(car_state[wheel].a_smooth.toFixed(2),8)}}</td>
          </tr>
        </tbody>
      </table>

    </div>
  <div class='itembox'>
      <div ng-repeat="cpu in pi_state.cpu">cpu{{$index}} <span class='data'>{{rjust(cpu,7)}}</span>
      </div>
    </div>

    <!-- final div eats up space on right-->
    <div></div> 

  </div>

  <div>
    <div class='groupbox'> 
      <div class='itembox'>
      track:
      <select class='select' name='2' ng-model="run_settings.track_name" id="2" ng-options="track_name for track_name in track_names"></select>
      </div>

      <div class='itembox'>
      route: <select class='select' name='1' ng-model="run_settings.route_name" id="1" ng-options="route_name for route_name in route_names"></select>
      </div>
   
      <button class='button' ng-click="poweroff()">Power Off</button>
      <button class='button' ng-click="save_run_settings()">Save</button>
      <button class='button' ng-click="go()">Go{{go_error}}</button>
      <button class='button' ng-click="stop()">Stop{{stop_error}}</button>
      <button class='button' ng-click="record()">Record{{record_error}}</button>
      <button class='button' ng-click="reset_odometer()">Reset Odometer{{record_error}}</button>
    </div>
  </div>
  <div class='groupbox'>
    <div class='itembox'>
      <svg 
      viewBox="{{route_path_min_x-0.5}} {{-route_path_max_y}} {{route_path_width+2}} {{route_path_height}}" 
      preserveAspectRatio="xMidYMid meet" 
      style="width:600px;height:600px">
          <!-- <line x1="0" y1="0" x2="1" y2="1" style="stroke:black;stroke-width:2"/> -->
          <!-- <g transform="rotate(90 {{route_path_width/2}} {{route_path_height/2}})"> -->
          <circle ng-repeat="path_node in route_path"  cx="{{route_path[$index].x}}" cy="{{-route_path[$index].y}}" r="0.01"/>
          <!-- <circle ng-attr-cx="{{car_state.front_x}}" ng-attr-cy="{{-car_state.front_y}}" r="0.2"/> -->
          <rect 
            ng-attr-x = "{{car_state.front_x-0.15}}" 
            ng-attr-y = "{{-car_state.front_y}}" 
            width = "0.3" 
            height = "0.6" 
            fill = "orage" 
            stroke = "none" 
            transform = "translate(0, 0) rotate({{-car_state.heading*180/Math.PI+90}} {{car_state.front_x}} {{-car_state.front_y}})"/>
          <!--<line 
            ng-repeat="path_node in route_path" 
            ng-if="! $last" 
            x1="{{route_path[$index].x}}" 
            y1="{{-route_path[$index].y}}" 
            x2="{{route_path[$index+1].x}}" 
            y2="{{-route_path[$index+1].y}}" 
            style="stroke:black;stroke-width:2px" vector-effect="non-scaling-stroke" />
          </g>
        -->
      </svg>
  </div>
  <div class='itembox'>
    <table>
      <tbody>
        <tr ng-repeat="item in run_settings_array" ng.key="item.key"> 
        <td>{{item.key}}</td>
        <td>
          <input type="checkbox" ng-if="item.data_type === 'boolean'" ng-model="item.value"/>
          <input 
            ng-if="item.data_type === 'number'" 
            ng-model="item.value" style='width:4ch' 
            ng-class="is_changed(item) ? 'changed' : ''"/>
        </td>
      <tr>
      </table>
  </div>
</div>

  <label><h3><input type="checkbox" id="xxx" ng-model="display_car_state"> car_state: </h3></label>
  <div class='groupbox'>
  <div ng-if="display_car_state" class='small_text' ng-repeat="(key,value) in car_state">{{key}} = {{value}}

  </div>
  </div>

</body>
<script>
var app = angular.module("car", []);
app.controller("carController", function($scope, $http, $timeout) {
  $scope.Math = Math

  $scope.type_of = function(val) { 
    return typeof(val); 
  };

  $scope.is_changed = function(field) {
    return field.original_value.toString() !== field.value.toString();

  }

  $scope.to_field_array = function(x) { 
    rv = []; 
    for(k in x) {
      rv.push({
        key:k,
        value:x[k],
        original_value:x[k],
        data_type:typeof(x[k])
        });
    }
    return rv;
  };

  $scope.set_changes_from_field_array = function(o, field_array) { 
    for(i in field_array) {
      var field = field_array[i];
      if($scope.is_changed(field)) {
        if(field.data_type == 'number') {
          o[field.key] = Number(field.value);
        }
        if(field.data_type == 'boolean)') {
          o[field.key] == Boolean(field.value);
        }
      }
    }
    return rv;
  };


  $scope.poweroff = function() {
    go_error = ""
    $http.put('/pi/poweroff',"1").success(function() {
      console.log('poweroff success');
    }).error(function(response,code) {
      $scope.go_error = "  ("+code+")"+response.message;
    })
    console.log("poweoff clicked");
  };


  $scope.save_run_settings = function() {
    go_error = ""
    $scope.set_changes_from_field_array($scope.run_settings, $scope.run_settings_array);
    req = {
      url:'/run_settings',
      method: 'PUT',
      data: JSON.stringify($scope.run_settings),
      headers: {
        'Content-Type': 'application/json'
      }
    };

    $http(req).success(function() {
      console.log('save run settings success');
    }).error(function(response,code) {
      $scope.go_error = "  ("+code+")"+response;
    });

    console.log("save_run_settings clicked");
    
  }


  $scope.go = function() {
    go_error = ""
    $http.put('/command/go',"1").success(function() {
      console.log('go success');
    }).error(function(response,code) {
      $scope.go_error = "  ("+code+")"+response.message;
    })
    console.log("go clicked");
  };

  $scope.stop = function() {
    $http.put('/command/stop',"1").success(function() {
      console.log('stop success');
    }).error(function(response,code) {
      $scope.stop_error = "  ("+code+")"+response.message;
    })
    console.log("stop clicked");
  };

  $scope.record = function() {
    $http.put('/command/record',"1").success(function() {
      console.log('record success');
    }).error(function(response,code) {
      $scope.record_error = "  ("+code+")"+response.message;
    })
    console.log("record clicked");
  };

  $scope.reset_odometer = function() {
    $http.put('/command/reset_odometer',"1").success(function() {
      console.log('reset_odometer success');
    }).error(function(response,code) {
      $scope.reset_odometer_error = "  ("+code+")"+response.message;
    })
    console.log("reset_odometer clicked");
  };
  

  $scope.$watch("run_settings.track_name", function(newValue, oldValue) {
    if ($scope.run_settings.track_name !== null && $scope.run_settings.track_name.length > 0) {
      console.log("selected track:",$scope.run_settings.track_name)
      $http.get('/tracks/'+$scope.run_settings.track_name+"/route_names").
        success(function(result, status, headers, config) {
          $scope.route_names = result.route_names
        }).error(function(data, status, headers, config) {
          $scope.route_names = ['n/a'];
        // log error
      });
    }
  });

  $scope.$watch("run_settings.route_name", function(newValue, oldValue) {
    if ($scope.run_settings.route_name !== null && $scope.run_settings.route_name.length > 0) {
      $http.get('/tracks/'+$scope.run_settings.track_name+"/routes/"+$scope.run_settings.route_name+"/path").
        success(function(route_path, status, headers, config) {
          $scope.route_path = route_path;
          var route_x = route_path.map(function(v){return v.x});
          var route_y = route_path.map(function(v){return v.y});

          $scope.route_path_min_x  = Math.min.apply(null, route_x)
          $scope.route_path_min_y  = Math.min.apply(null, route_y)
          $scope.route_path_max_x  = Math.max.apply(null, route_x)
          $scope.route_path_max_y  = Math.max.apply(null, route_y)
          $scope.route_path_width  = $scope.route_path_max_x - $scope.route_path_min_x
          $scope.route_path_height = $scope.route_path_max_y - $scope.route_path_min_y
        }).error(function(data, status, headers, config) {
          $scope.route_names = ['n/a'];
        // log error
        });
    }
  });


  $http.get('/track_names').
    success(function(result, status, headers, config) {
      $scope.track_names = result.track_names;
    }).
    error(function(data, status, headers, config) {
      // log error
    });
  $scope.poll_ok = false;
  $scope.display_car_state = false;


  var poller = function() {
    $http({method:'GET', timeout:5000, url : '/car/get_state'})
      .then(function(r) {
        $scope.car_state = r.data;
        var v_bat = $scope.car_state.v_bat;
        var min_bat = 3.5 * 3;
        var max_bat = 4.2 * 3;
        $scope.battery_percent = 100*(v_bat-min_bat)/(max_bat-min_bat);
        $scope.poll_ok = true;
        $timeout(poller, 100);
      },
      function(e) { 
        $scope.poll_ok = false;
        $timeout(poller,1000);
      });
    };
  poller();
  
  $scope.rjust = function(s, width) {
    s = s.toString()
    return " ".repeat(width-s.length)+s
  }

  var poller2 = function() {
    $http({method:'GET', timeout:5000, url : '/pi/get_state'})
      .then(function(r) {
        $scope.pi_state = r.data;
        $timeout(poller2,1000);
      },
      function(e) { 
        $timeout(poller2,1000);
      });
    };
  poller2();

  var poller3 = function() {
    $http({method:'GET', timeout:5000, url : '/run_settings'})
      .then(function(r) {
        $scope.run_settings = r.data;
        $scope.run_settings_array = $scope.to_field_array($scope.run_settings);
      },
      function(e) { 
        $timeout(poller3,1000);
      });
    };
  poller3();

});    
</script>    

</html>
